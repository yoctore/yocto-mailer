<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/modules/mandrill/index.js - yocto-mailer</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-mailer" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Mailer.html">Mailer</a></li>
                                <li><a href="../classes/MandrillWrapper.html">MandrillWrapper</a></li>
                                <li><a href="../classes/NodeMailer.html">NodeMailer</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/modules/mandrill/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var mandrill = require(&#x27;mandrill-api/mandrill&#x27;);
var _        = require(&#x27;lodash&#x27;);
var joi      = require(&#x27;joi&#x27;);
var logger   = require(&#x27;yocto-logger&#x27;);


/**
* Yocto MandrillWrapper
*
* This module manage your own mailer
*
* This module his a wrapper of mandrill-api for node js package
*
* For more details on used dependencies read links below :
* - yocto-logger : git+ssh://lab.yocto.digital:yocto-node-modules/yocto-utils.git
* - LodAsh : https://lodash.com/
* - joi : https://github.com/hapijs/joi
* - mandrill-api : https://www.npmjs.com/package/mandrill-api
*
* @date : 08/06/2015
* @author : Cédric BALARD &lt;cedric@yocto.re&gt;
* @copyright : Yocto SAS, All right reserved
* @class MandrillWrapper
*/
function MandrillWrapper() {

  /**
  * The mandrill client for sending mail
  *
  * @property {Object} mandrill_client
  * @default empty
  */
  this.mandrill_client = {};

  /**
  * Structure of the object that contains all mail options
  *
  * @property {Object} mailOptions
  * @default {
  * 	  from_email    : &#x27;&#x27;,
  *     to      : &#x27;&#x27;,
  *     subject : &#x27;&#x27;,
  *     html    : &#x27;&#x27;
  *     }
  */
  this.mailOptions = {
    from_email  : &#x27;&#x27;, // sender address
    to          : [], // list of receivers
    subject     : &#x27;&#x27; // Subject line
  };

  /**
  * Clone the mailOptions and omit parameter &#x27;from_email&#x27;&lt;br/&gt;
  * It used for deleteMailOptions when a mail as sent to reinitialize it&lt;br/&gt;
  *
  * @property {Object} defaultMailOtpion
  *  @default {
  *     to      : &#x27;&#x27;,
  *     subject : &#x27;&#x27;,
  *     html    : &#x27;&#x27;,
  *     }
  */
  this.defaultMailOption = _.omit(_.clone(this.mailOptions), &#x27;from_email&#x27;);
}

/**
* Set the mandrill client apiKey to connect to mandrill service
*
* @method setMandrillClientAPIKey
* @param {Object}  apiKey The apikey of mandrill service
* @example example of usage
*    mailer.mandrill.setMandrillClientAPIKey(&#x27;JFEKFEa-738dKJFEç-OLN974&#x27;);
*/
MandrillWrapper.prototype.setMandrillClientAPIKey = function(apiKey) {

  if (_.isString(apiKey)) {
    this.mandrill_client = new mandrill.Mandrill(apiKey);
  }
};

/**
* Add a new recipient or an array of recipient&lt;br/&gt;
* This will add a new recipient to the array of recipient
*
* @method addRecipient
* @param {Object, Array} rec
* @return {Boolean} true if success, false otherwise
* @example
*
*var user = {
*  name  : &#x27;Foo Bar&#x27;,
*  email : &#x27;foo@bar.com&#x27;
*};
* mailer.nodemailer.addRecipient(user);
*/
MandrillWrapper.prototype.addRecipient = function(rec) {

  return this.processEmailFormat(rec, &#x27;to&#x27;);
};

/**
* Set the expeditor &lt;br/&gt;
* This param is save in memory
*
* @method setExpeditor
* @param {String}  from email of the exoeditor
* @return {Boolean} true if success, false otherwise
*/
MandrillWrapper.prototype.setExpeditor = function(from) {

  //From email should be a string
  if (!_.isString(from)) {
    return &#x27;Error - from_email should be a string email&#x27;;
  }
  return this.processEmailFormat(from, &#x27;from_email&#x27;);
};

/**
* Add a new CC recipient or an array of CC recipient&lt;br/&gt;
* This will add a new cc to the array of cc
*
* @method addCC
* @param {Object, Array}  cc
* @return {Boolean} true if success, false otherwise
*
* @example
*
*var user = {
*  name  : &#x27;Foo Bar&#x27;,
*  email : &#x27;foo@bar.com&#x27;
*};
* mailer.nodemailer.addCC(user);
*/
MandrillWrapper.prototype.addCC = function(cc) {

  return this.processEmailFormat(cc, &#x27;to&#x27;, &#x27;cc&#x27;);
};

/**
* Add a new BCC recipient or an array of BCC recipient&lt;br/&gt;
* This will add a new cc to the array of Bcc
*
* @method addBCC
* @param {Object, Array} bcc
* @return {Boolean} true if success, false otherwise
*
* @example
*
*var user = {
*  name  : &#x27;Foo Bar&#x27;,
*  email : &#x27;foo@bar.com&#x27;
*};
* mailer.nodemailer.addBCC(user);
*/
MandrillWrapper.prototype.addBCC = function(bcc) {

  return this.processEmailFormat(bcc, &#x27;to&#x27;, &#x27;bcc&#x27;);
};

/**
* Check if object &#x27;data&#x27; conatains only email &lt;br/&gt;
* If it&#x27;s not case return false and logg an error &lt;br/&gt;
* Else add &#x27;data&#x27; into Mailer.mailOptions.&lt;option&gt;
*
* @method processEmailFormat
* @private
* @param {String, Array, Object}  data that shoul&#x27;d be contains email
* @param option It&#x27;s the name of the property in Mailer.mailOptions
* @param option2 It&#x27;s an optional otpion to specify if it&#x27;s an cc, bcc
* @return {Boolean} true if success, false otherwise
*/
MandrillWrapper.prototype.processEmailFormat = function(data, option, option2) {

  if (option !== &#x27;from_email&#x27; &amp;&amp; !_.isObject(data)) {
    logger.error(&#x27;Error &#x27; + option + &#x27; should be on object or array of object&#x27;);
    return &#x27;Error &#x27; + option + &#x27; should be on object or array of object&#x27;;
  }

  //Set a default value
  var result = joi.string().email();

  if (_.isObject(data)) {

    //data is an array
    if (_.isArray(data)) {

      //Add params type to each user
      _.forEach(data, function(user) {

        user = _.merge(user, { type : (_.isEmpty(option2) ? option : option2) });
      });

      //Define joi schema
      result = joi.array().items(
        joi.object().keys({
          email : joi.string().email(),
          name  : joi.string(),
          type  : joi.string()
        })
      );
    } else {
      // Data is an Object
      // Add param type in data
      data = _.merge(data, { type : (_.isEmpty(option2) ? option : option2) });  // add the param &#x27;type&#x27;

      //Define joi schema
      result = joi.object().keys({
        email : joi.string().email(),
        name  : joi.string(),
        type  : joi.string()
      });
    }
  }

  //Execute the joi vailidation
  result = result.validate(data);

  //Check if have no error in joi validation
  if (_.isEmpty(result) || _.isEmpty(result.error)) {
    logger.debug(&#x27;[ MandrillWrapper.processEmailFormat ] - Validation email for field : &#x27; +  (_.isEmpty(option2) ? option : option2));

    //test the type of param in mailOptions
    if (_.isArray(this.mailOptions[option]) &amp;&amp; _.isObject(data)) {
      //is an array

      //Change result if needed
      if (_.isArray(data)) {

        //is an array
        _.forEach(data, function(user) {
          this.mailOptions[option].push(user);
        }, this);
        return true;
      }

      //is an object
      this.mailOptions[option].push(data);
      return true;
    }

    //the param is a string
    this.mailOptions[option] = data;
    return true;
  }

  logger.error(&#x27;[ MandrillWrapper.processEmailFormat ] - Validation email failed, at least one string dosen\&#x27;t pass email validation for field : &#x27; + option);
  console.log(result.error);
  return false;
};

/**
* Send the mail with all parameters ( from_email, to, cc , bcc)&lt;br/&gt;
* After the mail was send this paramater will be remove : to, cc, bcc, subject, message
*
* @method send
* @param {String} subject Subject of the email
* @param {String} message Html message to send
* @param {Function} callback on optional success callback, If is not specied a default callback will be execute
* @param {Function} callbackFailed on optional failed callback, If is not specied a default callback will be execute
* @example Obligatory step before call this method
* 1. require the module like this : var mandrill = require(&#x27;MandrillWrapper&#x27;);
* 2. set a valid mandrill apiKey
* 3. set an expeditor
* 4. set at least one recipient
*     - You can optionaly add CC or BCC receivers
* 5. call send() with your subject and contents for sending your email
*/
MandrillWrapper.prototype.send = function(subject, message, callback, callbackFailed) {

  // send mail with defined transport object
  logger.debug(&#x27;[ MandrillWrapper.send ] - Try sending a new email&#x27;);

  if (_.isString(message)) {
    this.mailOptions.html = message;
  }

  if (_.isString(subject)) {
    this.mailOptions.subject = subject;
  }

  //Default callback will call in case where &#x27;callback&#x27; is empty
  function defaultCallbackSendMail(info) {

    logger.info(&#x27;[ MandrillWrapper.send.defaultCallBackSendMail ] - message sent, more info : &#x27; + info);
  }

  //Default callback will call in case where &#x27;callback&#x27; is empty
  function defaultFailedCallbackSendMail(error) {

    logger.error(&#x27;[ MandrillWrapper.send.defaultCallBackSendMail ] -  error sending message, more details : &#x27; + error);
  }

  //saveContext for deleteMailOptions()
  var context = this;

  //Function that delete all params in this.mailOptions expect &#x27;from&#x27;
  function deleteMailOptions() {

    logger.debug(&#x27;[ MandrillWrapper.deleteMailOptions ] - Delete mail otpions&#x27;);

    //Extend defaultMailOption to remove this mail options : to, cc, bcc, html
    _.extend(context.mailOptions, context.defaultMailOption);
  }

  //Check if somes params are not empty
  if (!_.isEmpty(this.mandrill_client) &amp;&amp; !_.isEmpty(this.mailOptions.to) &amp;&amp;
  !_.isEmpty(this.mailOptions.from_email)  &amp;&amp; !_.isEmpty(this.mailOptions.subject)  &amp;&amp;
  !_.isEmpty(this.mailOptions.html)) {

    return this.mandrill_client.messages.send({ &quot;message&quot;: this.mailOptions, &quot;async&quot;: false }, function(result) {

      // Success Callback

      //Determine which callback is called
      if (!_.isFunction(callback)) {
        defaultCallbackSendMail(result);
      } else {
        callback(result);
      }

      //Delete mail options
      deleteMailOptions();
      return true;

    } , function(e) {
      // failed callback
      //
      //Determine which callback is called
      if (!_.isFunction(callbackFailed)) {
        defaultFailedCallbackSendMail(e);
      } else {
        callbackFailed(e);
      }

      //Delete mail options
      deleteMailOptions();
      return false;
    });
  }
  //At least one params are empty, so the mail will be not sent
  logger.error(&#x27;[ MandrillWrapper.send ] - can\&#x27;t send mail, please check configuration.&#x27;);

  //Delete mail options
  deleteMailOptions();
  return false;
};

/**
* Export the wrapper to use it on node
*/
module.exports = new (MandrillWrapper)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
