"use strict";function Mailer(){this.transport={},this.mailOptions={from:"",to:"",subject:"",html:"",cc:"",bcc:""}}var nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport"),logger=require("yocto-logger"),_=require("lodash"),Joi=require("joi");Mailer.prototype.addRecipient=function(a){var b;if(_.isString(a))b=Joi.string().email().validate(a);else if(_.isArray(a)){var c=Joi.array().items(Joi.string().email());b=c.validate(a)}return _.isEmpty(b)||_.isEmpty(b.error)?(logger.info("adding destinataire ok"),this.mailOptions.to=a,!0):(logger.warning("Error : at least one string dosen't pass email validation"),!1)},Mailer.prototype.setConfigSMTP=function(a){var b=Joi.object().keys({host:Joi.string().required(),secureConnection:Joi["boolean"]().required(),port:Joi.number().required(),auth:Joi.object().keys({user:Joi.string().email().required(),pass:Joi.string().required()})}),c=Joi.validate(a,b);return _.isEmpty(c)||_.isEmpty(c.error)?(logger.info("set smtp conf ok "),this.transport=nodemailer.createTransport(smtpTransport(a)),!0):(logger.error(" setting smtp : doesn't match "),_.forEach(c.error.details,function(a){logger.warning(a.message+" at "+a.path)}),!1)},Mailer.prototype.setExpeditor=function(a){return _.isString(a)?(this.mailOptions.from=a,logger.info("set expeditor "),!0):!1},Mailer.prototype.addCC=function(a){var b;if(_.isString(a))b=Joi.string().email().validate(a);else if(_.isArray(a)){var c=Joi.array().items(Joi.string().email());b=c.validate(a)}return _.isEmpty(b)||_.isEmpty(b.error)?(logger.info("adding CC ok"),this.mailOptions.cc=a,!0):(logger.error(" adding cc : at least one string dosen't pass email validation"),!1)},Mailer.prototype.addBCC=function(a){var b;if(_.isString(a))b=Joi.string().email().validate(a);else if(_.isArray(a)){var c=Joi.array().items(Joi.string().email());b=c.validate(a)}return _.isEmpty(b)||_.isEmpty(b.error)?(logger.info("adding bcc ok"),this.mailOptions.bcc=a,!0):(logger.error(" adding bcc : at least one string dosen't pass email validation"),!1)},Mailer.prototype.send=function(a,b,c){logger.info("send mail "),_.isString(b)&&(this.mailOptions.html=b),_.isString(a)&&(this.mailOptions.subject=a);_.isEmpty(this.transport)||_.isEmpty(this.mailOptions.to)||_.isEmpty(this.mailOptions.from)?logger.error("can't send mail, please check configuration : \n"+this.mailOptions):_.isUndefined(c)?this.transport.sendMail(this.mailOptions,function(a,b){a?logger.error(a):logger.info(" +++ Message sent: "+b.response)}):this.transport.sendMail(this.mailOptions,c),this.deleteMailOptions()},Mailer.prototype.deleteMailOptions=function(){logger.info("delete some mail options : to, cc, bcc, subject, html "),this.mailOptions.to="",this.mailOptions.cc="",this.mailOptions.bcc="",this.mailOptions.subject="",this.mailOptions.html=""},module.exports=new Mailer;