"use strict";function Mailer(){this.transport={},this.logger=logger,this.mailOptions={from:"",to:"",subject:"",html:"",cc:"",bcc:""},this.defaultMailOption=_.omit(_.clone(this.mailOptions),"from")}var nodemailer=require("nodemailer"),smtpTransport=require("nodemailer-smtp-transport"),logger=require("yocto-logger"),_=require("lodash"),joi=require("joi"),util=require("util");Mailer.prototype.setConfigSMTP=function(a){var b=joi.object().keys({host:joi.string().required(),secureConnection:joi["boolean"]().required(),port:joi.number().required(),auth:joi.object().keys({user:joi.string().email().required(),pass:joi.string().required()}).allow("user","pass")}).allow("host","secureConnection","port","auth"),c=joi.validate(a,b);return _.isEmpty(c)||_.isEmpty(c.error)?(logger.info("[ Mailer.setConfigSMTP ] - New config is valid."),this.transport=nodemailer.createTransport(smtpTransport(a)),!0):(this.logger.error([" [ Mailer.setConfigSMTP ] - Config is invalid. error is : ",util.inspect(c.error.details,{depth:null})]),!1)},Mailer.prototype.addRecipient=function(a){return this.processEmailFormat(a,"to")},Mailer.prototype.setExpeditor=function(a){return console.log(a),this.processEmailFormat(a,"from")},Mailer.prototype.addCC=function(a){return this.processEmailFormat(a,"cc")},Mailer.prototype.addBCC=function(a){return this.processEmailFormat(a,"bcc")},Mailer.prototype.processEmailFormat=function(a,b){var c=joi.string().email().required().empty();_.isArray(a)&&(c=joi.array().min(1).items(joi.string().email().required().empty()));var d=joi.string().required().empty().valid(["from","bcc","cc","to"]).validate(b);if(c=c.validate(a),_.isNull(c.error)&&_.isNull(d.error))return logger.info(["[ Mailer.processEmailFormat ] - Checking field :",b,"with data :",util.inspect(a,{depth:null}),"is ok"].join(" ")),this.mailOptions[b]=a,!0;var e=[c.error,d.error];return _.each(e,function(a){!_.isNull(a)&&_.has(a,"details")&&this.logger.error(["[ Mailer.processEmailFormat ] - Validation failed. validate error is :\n",util.inspect(a.details,{depth:null})].join(" "))},this),!1},Mailer.prototype.send=function(a,b,c){if(_.isString(b)&&(this.mailOptions.html=b),_.isString(a)&&(this.mailOptions.subject=a),_.isEmpty(this.transport)||_.isEmpty(this.mailOptions.to)||_.isEmpty(this.mailOptions.from)||_.isEmpty(this.mailOptions.subject)||_.isEmpty(this.mailOptions.html))logger.error("[ Mailer.send ] - Configuration is invalid. Please check your settings.");else{this.logger.info(["[ Mailer.send ] - Sending email to : ",this.mailOptions.to].join(" ")),this.logger.debug(["[ Mailer.send ] - Sending with option : ",util.inspect(this.mailOptions,{depth:null})].join(" "));var d=this;this.transport.sendMail(this.mailOptions,function(a,b){a?d.logger.error(["[ Mailer.send ] - An error occured during sending email. Error is :",util.inspect(a,{depth:null})].join(" ")):d.logger.info(["[ Mailer.send ] - Sending email success. response is :\n",util.inspect(b,{depth:null})].join(" ")),_.isFunction(c)&&c(a,b)})}return this.clean()},Mailer.prototype.clean=function(){return this.logger.info("[ Mailer.clean ] - Cleaning mail otpions"),_.extend(this.mailOptions,this.defaultMailOption),this.mailOptions},module.exports=new Mailer;