"use strict";function MandrillWrapper(){this.mandrill_client={},this.mailOptions={from_email:"",to:[],subject:""},this.defaultMailOption=_.omit(_.clone(this.mailOptions),"from_email")}var mandrill=require("mandrill-api/mandrill"),_=require("lodash"),joi=require("joi"),logger=require("yocto-logger");MandrillWrapper.prototype.setMandrillClientAPIKey=function(a){_.isString(a)&&(this.mandrill_client=new mandrill.Mandrill(a))},MandrillWrapper.prototype.addRecipient=function(a){return this.processEmailFormat(a,"to")},MandrillWrapper.prototype.setExpeditor=function(a){return _.isString(a)?this.processEmailFormat(a,"from_email"):"Error - from_email should be a string email"},MandrillWrapper.prototype.addCC=function(a){return this.processEmailFormat(a,"to","cc")},MandrillWrapper.prototype.addBCC=function(a){return this.processEmailFormat(a,"to","bcc")},MandrillWrapper.prototype.processEmailFormat=function(a,b,c){if("from_email"!==b&&!_.isObject(a))return logger.error("Error "+b+" should be on object or array of object"),"Error "+b+" should be on object or array of object";var d=joi.string().email();return _.isObject(a)&&(_.isArray(a)?(_.forEach(a,function(a){a=_.merge(a,{type:_.isEmpty(c)?b:c})}),d=joi.array().items(joi.object().keys({email:joi.string().email(),name:joi.string(),type:joi.string()}))):(a=_.merge(a,{type:_.isEmpty(c)?b:c}),d=joi.object().keys({email:joi.string().email(),name:joi.string(),type:joi.string()}))),d=d.validate(a),_.isEmpty(d)||_.isEmpty(d.error)?(logger.debug("[ MandrillWrapper.processEmailFormat ] - Validation email for field : "+(_.isEmpty(c)?b:c)),_.isArray(this.mailOptions[b])&&_.isObject(a)?_.isArray(a)?(_.forEach(a,function(a){this.mailOptions[b].push(a)},this),!0):(this.mailOptions[b].push(a),!0):(this.mailOptions[b]=a,!0)):(logger.error("[ MandrillWrapper.processEmailFormat ] - Validation email failed, at least one string dosen't pass email validation for field : "+b),console.log(d.error),!1)},MandrillWrapper.prototype.send=function(a,b,c,d){function e(a){logger.info("[ MandrillWrapper.send.defaultCallBackSendMail ] - message sent, more info : "+a)}function f(a){logger.error("[ MandrillWrapper.send.defaultCallBackSendMail ] -  error sending message, more details : "+a)}function g(){logger.debug("[ MandrillWrapper.deleteMailOptions ] - Delete mail otpions"),_.extend(h.mailOptions,h.defaultMailOption)}logger.debug("[ MandrillWrapper.send ] - Try sending a new email"),_.isString(b)&&(this.mailOptions.html=b),_.isString(a)&&(this.mailOptions.subject=a);var h=this;return _.isEmpty(this.mandrill_client)||_.isEmpty(this.mailOptions.to)||_.isEmpty(this.mailOptions.from_email)||_.isEmpty(this.mailOptions.subject)||_.isEmpty(this.mailOptions.html)?(logger.error("[ MandrillWrapper.send ] - can't send mail, please check configuration."),g(),!1):this.mandrill_client.messages.send({message:this.mailOptions,async:!1},function(a){return _.isFunction(c)?c(a):e(a),g(),!0},function(a){return _.isFunction(d)?d(a):f(a),g(),!1})},module.exports=new MandrillWrapper;